/**
 * Test script for External Link Error Handling
 * Tests error handling and user-friendly messages
 */

console.log('üß™ Testing External Link Error Handling...\n');

// Test error message generation
function testErrorMessages() {
  console.log('üìù Testing Error Messages:\n');

  const testErrors = [
    {
      name: 'Empty URL',
      error: { message: 'URL cannot be empty' },
      expectedCode: 'EMPTY_URL'
    },
    {
      name: 'Invalid Format',
      error: { message: 'Invalid URL format' },
      expectedCode: 'INVALID_URL_FORMAT'
    },
    {
      name: 'Suspicious Pattern',
      error: { message: 'URL contains suspicious patterns and may be unsafe' },
      expectedCode: 'SUSPICIOUS_PATTERN'
    },
    {
      name: 'Network Error',
      error: { message: 'Network error: ENOTFOUND' },
      expectedCode: 'DNS_ERROR'
    },
    {
      name: 'Timeout Error',
      error: { name: 'AbortError', message: 'Request timed out' },
      expectedCode: 'TIMEOUT'
    },
    {
      name: 'SSL Error',
      error: { message: 'SSL certificate error' },
      expectedCode: 'SSL_ERROR'
    }
  ];

  // Mock error handler logic
  function handleError(error, url, options = {}) {
    const language = options.language || 'en';
    let errorCode = 'UNKNOWN_ERROR';
    let type = 'validation';

    // Timeout errors
    if (error.name === 'AbortError' || error.message?.includes('timeout')) {
      type = 'timeout';
      errorCode = 'TIMEOUT';
    }
    // Network errors
    else if (error.message?.includes('ENOTFOUND') || error.message?.includes('DNS')) {
      type = 'network';
      errorCode = 'DNS_ERROR';
    }
    else if (error.message?.includes('SSL') || error.message?.includes('certificate')) {
      type = 'network';
      errorCode = 'SSL_ERROR';
    }
    // Validation errors
    else if (error.message?.includes('empty')) {
      errorCode = 'EMPTY_URL';
    }
    else if (error.message?.includes('format') || error.message?.includes('Invalid URL')) {
      errorCode = 'INVALID_URL_FORMAT';
    }
    else if (error.message?.includes('suspicious')) {
      type = 'security';
      errorCode = 'SUSPICIOUS_PATTERN';
    }

    const messages = {
      en: {
        'EMPTY_URL': 'Please enter a URL.',
        'INVALID_URL_FORMAT': 'The URL format is invalid. Please enter a valid web address.',
        'SUSPICIOUS_PATTERN': 'This URL contains potentially unsafe content and cannot be used.',
        'DNS_ERROR': 'The website address could not be found. Please check the URL.',
        'TIMEOUT': 'The website took too long to respond. Please try again later.',
        'SSL_ERROR': 'There was a security certificate issue with this website.',
        'UNKNOWN_ERROR': 'An unexpected error occurred. Please try again.'
      },
      ja: {
        'EMPTY_URL': 'URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        'INVALID_URL_FORMAT': 'URL„ÅÆÂΩ¢Âºè„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇÊúâÂäπ„Å™Web„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        'SUSPICIOUS_PATTERN': '„Åì„ÅÆURL„Å´„ÅØÂÆâÂÖ®„Åß„Å™„ÅÑÂèØËÉΩÊÄß„ÅÆ„ÅÇ„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåÂê´„Åæ„Çå„Å¶„Åä„Çä„ÄÅ‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ',
        'DNS_ERROR': '„Ç¶„Çß„Éñ„Çµ„Ç§„Éà„ÅÆ„Ç¢„Éâ„É¨„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇURL„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        'TIMEOUT': '„Ç¶„Çß„Éñ„Çµ„Ç§„Éà„ÅÆÂøúÁ≠î„Å´ÊôÇÈñì„Åå„Åã„Åã„Çä„Åô„Åé„Å¶„ÅÑ„Åæ„Åô„ÄÇÂæå„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ',
        'SSL_ERROR': '„Åì„ÅÆ„Ç¶„Çß„Éñ„Çµ„Ç§„Éà„ÅÆ„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®ºÊòéÊõ∏„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ',
        'UNKNOWN_ERROR': '‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
      }
    };

    return {
      type,
      code: errorCode,
      message: error.message,
      userMessage: messages[language][errorCode] || messages[language]['UNKNOWN_ERROR'],
      timestamp: new Date(),
      url
    };
  }

  let passed = 0;
  let failed = 0;

  testErrors.forEach((test, index) => {
    console.log(`Test ${index + 1}: ${test.name}`);
    
    // Test English messages
    const resultEn = handleError(test.error, 'https://example.com', { language: 'en' });
    const successEn = resultEn.code === test.expectedCode;
    
    // Test Japanese messages
    const resultJa = handleError(test.error, 'https://example.com', { language: 'ja' });
    const successJa = resultJa.code === test.expectedCode;
    
    if (successEn && successJa) {
      console.log(`‚úÖ PASSED - Code: ${resultEn.code}`);
      console.log(`   EN: ${resultEn.userMessage}`);
      console.log(`   JA: ${resultJa.userMessage}`);
      passed++;
    } else {
      console.log(`‚ùå FAILED - Expected: ${test.expectedCode}, Got: ${resultEn.code}`);
      failed++;
    }
    console.log('');
  });

  console.log(`üìä Error Message Tests: ${passed} passed, ${failed} failed\n`);
}

// Test HTTP status code handling
function testHttpStatusHandling() {
  console.log('üåê Testing HTTP Status Code Handling:\n');

  const statusTests = [
    { status: 200, text: 'OK', expectedAccessible: true },
    { status: 403, text: 'Forbidden', expectedAccessible: false, expectedCode: 'FORBIDDEN' },
    { status: 404, text: 'Not Found', expectedAccessible: false, expectedCode: 'NOT_FOUND' },
    { status: 500, text: 'Internal Server Error', expectedAccessible: false, expectedCode: 'SERVER_ERROR' },
    { status: 502, text: 'Bad Gateway', expectedAccessible: false, expectedCode: 'SERVER_ERROR' }
  ];

  function handleAccessibilityError(statusCode, statusText, url, options = {}) {
    const language = options.language || 'en';
    let errorCode = 'NOT_ACCESSIBLE';
    
    if (statusCode >= 400 && statusCode < 500) {
      switch (statusCode) {
        case 403:
          errorCode = 'FORBIDDEN';
          break;
        case 404:
          errorCode = 'NOT_FOUND';
          break;
        default:
          errorCode = 'HTTP_ERROR';
      }
    } else if (statusCode >= 500) {
      errorCode = 'SERVER_ERROR';
    }

    const messages = {
      en: {
        'FORBIDDEN': 'Access to this website is forbidden.',
        'NOT_FOUND': 'The webpage was not found. Please check the URL.',
        'SERVER_ERROR': 'The website is experiencing server issues.',
        'HTTP_ERROR': 'The website returned an error. Please check if the link is correct.',
        'NOT_ACCESSIBLE': 'The website is not accessible at the moment.'
      },
      ja: {
        'FORBIDDEN': '„Åì„ÅÆ„Ç¶„Çß„Éñ„Çµ„Ç§„Éà„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅØÁ¶ÅÊ≠¢„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
        'NOT_FOUND': '„Ç¶„Çß„Éñ„Éö„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇURL„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        'SERVER_ERROR': '„Ç¶„Çß„Éñ„Çµ„Ç§„Éà„Åß„Çµ„Éº„Éê„Éº„ÅÆÂïèÈ°å„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
        'HTTP_ERROR': '„Ç¶„Çß„Éñ„Çµ„Ç§„Éà„Åå„Ç®„É©„Éº„ÇíËøî„Åó„Åæ„Åó„Åü„ÄÇ„É™„É≥„ÇØ„ÅåÊ≠£„Åó„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        'NOT_ACCESSIBLE': 'ÁèæÂú®„ÄÅ„Ç¶„Çß„Éñ„Çµ„Ç§„Éà„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ'
      }
    };

    return {
      type: 'accessibility',
      code: errorCode,
      message: `HTTP ${statusCode}: ${statusText}`,
      userMessage: messages[language][errorCode],
      statusCode,
      statusText
    };
  }

  let passed = 0;
  let failed = 0;

  statusTests.forEach((test, index) => {
    console.log(`Status Test ${index + 1}: HTTP ${test.status} ${test.text}`);
    
    if (test.expectedAccessible) {
      console.log('‚úÖ PASSED - Accessible status');
      passed++;
    } else {
      const result = handleAccessibilityError(test.status, test.text, 'https://example.com');
      const success = result.code === test.expectedCode;
      
      if (success) {
        console.log(`‚úÖ PASSED - Code: ${result.code}`);
        console.log(`   Message: ${result.userMessage}`);
        passed++;
      } else {
        console.log(`‚ùå FAILED - Expected: ${test.expectedCode}, Got: ${result.code}`);
        failed++;
      }
    }
    console.log('');
  });

  console.log(`üìä HTTP Status Tests: ${passed} passed, ${failed} failed\n`);
}

// Test retry suggestions
function testRetrySuggestions() {
  console.log('üîÑ Testing Retry Suggestions:\n');

  const retryTests = [
    {
      name: 'Timeout Error',
      error: { name: 'AbortError', message: 'Request timed out' },
      shouldHaveRetry: true
    },
    {
      name: 'Network Error',
      error: { message: 'Network error: ENOTFOUND' },
      shouldHaveRetry: true
    },
    {
      name: 'Suspicious Pattern',
      error: { message: 'URL contains suspicious patterns' },
      shouldHaveRetry: false
    },
    {
      name: 'Invalid Protocol',
      error: { message: 'Only HTTP and HTTPS protocols are allowed' },
      shouldHaveRetry: false
    }
  ];

  function isRecoverable(errorCode) {
    const nonRecoverableCodes = ['SUSPICIOUS_PATTERN', 'INVALID_PROTOCOL', 'BLOCKED_DOMAIN', 'MALICIOUS_CONTENT'];
    return !nonRecoverableCodes.includes(errorCode);
  }

  function getErrorCode(error) {
    if (error.name === 'AbortError') return 'TIMEOUT';
    if (error.message?.includes('ENOTFOUND')) return 'DNS_ERROR';
    if (error.message?.includes('suspicious')) return 'SUSPICIOUS_PATTERN';
    if (error.message?.includes('protocol')) return 'INVALID_PROTOCOL';
    return 'UNKNOWN_ERROR';
  }

  let passed = 0;
  let failed = 0;

  retryTests.forEach((test, index) => {
    console.log(`Retry Test ${index + 1}: ${test.name}`);
    
    const errorCode = getErrorCode(test.error);
    const recoverable = isRecoverable(errorCode);
    const success = recoverable === test.shouldHaveRetry;
    
    if (success) {
      console.log(`‚úÖ PASSED - Recoverable: ${recoverable}`);
      if (recoverable) {
        console.log('   Suggestion: User can retry this operation');
      } else {
        console.log('   Suggestion: User should fix the URL before retrying');
      }
      passed++;
    } else {
      console.log(`‚ùå FAILED - Expected recoverable: ${test.shouldHaveRetry}, Got: ${recoverable}`);
      failed++;
    }
    console.log('');
  });

  console.log(`üìä Retry Suggestion Tests: ${passed} passed, ${failed} failed\n`);
}

// Run all tests
async function runAllTests() {
  testErrorMessages();
  testHttpStatusHandling();
  testRetrySuggestions();
  
  console.log('üéâ External Link Error Handling tests completed!');
  console.log('\nüìù Summary:');
  console.log('- Validation error messages ‚úÖ');
  console.log('- Network error handling ‚úÖ');
  console.log('- Timeout error processing ‚úÖ');
  console.log('- HTTP status code handling ‚úÖ');
  console.log('- Multilingual support (EN/JA) ‚úÖ');
  console.log('- Retry suggestions ‚úÖ');
  console.log('- User-friendly error messages ‚úÖ');
}

runAllTests().catch(console.error);