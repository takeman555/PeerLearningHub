# コミュニティ機能修正マイグレーションガイド

## 概要

このガイドでは、コミュニティ機能の修正に必要なデータベースマイグレーションを実行する手順を説明します。

## 修正内容

### 1. いいね機能の改善
- 重複処理防止機能を追加
- `upsert`を使用して重複挿入を防止
- エラーハンドリングの強化
- UI側での重複クリック防止

### 2. 投稿削除機能の修正
- 本人または管理者のみ削除可能に変更
- 削除確認ダイアログを追加
- 関連するいいねも同時に削除
- 適切なエラーメッセージの表示

### 3. コミュニティメンバー表示の改善
- 認証済み + サブスクリプション購入者 + 表示希望者のみ表示
- 管理者を最初に表示
- 新しいカラム追加（`role`, `show_in_community`, `membership_status`）

### 4. グループ外部参加リンクの改善
- 権限チェック強化（作成者または管理者のみ）
- 既存リンクの再利用機能
- 有効期限を30日に延長
- 環境別URL設定

## マイグレーション手順

### ステップ1: Supabaseダッシュボードにアクセス

1. [Supabase Dashboard](https://app.supabase.com) にログイン
2. PeerLearningHubプロジェクトを選択
3. 左サイドバーから「SQL Editor」をクリック

### ステップ2: マイグレーションSQLを実行

1. 新しいクエリを作成
2. `supabase/migrations/014_complete_community_fixes.sql` の内容をコピー
3. SQLエディタに貼り付け
4. 「Run」ボタンをクリックして実行

### ステップ3: 実行結果の確認

マイグレーションが成功すると、以下の結果が表示されます：

```
integrity_check_passed
----------------------
t
```

エラーが発生した場合は、エラーメッセージを確認して対処してください。

### ステップ4: 修正の検証

マイグレーション実行後、以下のスクリプトで修正を検証できます：

```bash
cd PeerLearningHub
node scripts/directSchemaCheck.js
```

すべてのカラムが存在し、外部キー関係が正しく設定されていることを確認してください。

## 追加されるカラム

### profilesテーブル

| カラム名 | データ型 | デフォルト値 | 説明 |
|---------|---------|-------------|------|
| `role` | TEXT | 'user' | ユーザーロール（user, admin） |
| `show_in_community` | BOOLEAN | true | コミュニティメンバー一覧での表示可否 |
| `membership_status` | TEXT | 'free' | メンバーシップステータス（free, premium, lifetime） |

## RLSポリシーの更新

### profilesテーブル
- ユーザーは全てのプロフィールを閲覧可能
- ユーザーは自分のプロフィールのみ作成・更新可能

### postsテーブル
- ユーザーは全ての投稿を閲覧可能
- ユーザーは自分の投稿のみ作成・更新可能
- ユーザーは自分の投稿を削除可能、管理者は全ての投稿を削除可能

### post_likesテーブル
- ユーザーは全てのいいねを閲覧可能
- ユーザーは自分のいいねのみ管理可能

## トラブルシューティング

### よくあるエラー

#### 1. 外部キー制約エラー
```
ERROR: insert or update on table "posts" violates foreign key constraint "posts_user_id_fkey"
```

**解決方法**: 投稿を作成する前に、有効なプロフィールが存在することを確認してください。

#### 2. カラムが存在しないエラー
```
ERROR: column profiles.role does not exist
```

**解決方法**: マイグレーションが正しく実行されていません。ステップ2を再実行してください。

#### 3. RLS ポリシーエラー
```
ERROR: new row violates row-level security policy
```

**解決方法**: 適切な認証トークンでリクエストを送信していることを確認してください。

## 検証手順

### 1. スキーマ検証
```bash
node scripts/directSchemaCheck.js
```

### 2. 機能テスト
```bash
node scripts/testCommunityFixes.js
```

### 3. 手動テスト
1. アプリを起動
2. コミュニティ画面でいいね機能をテスト
3. 投稿削除機能をテスト（本人と管理者で）
4. コミュニティメンバー一覧の表示をテスト

## 注意事項

- マイグレーション実行前にデータベースのバックアップを取ることを推奨します
- 本番環境での実行前に、開発環境で十分にテストしてください
- エラーが発生した場合は、ログを確認して適切に対処してください

## サポート

問題が発生した場合は、以下の情報を含めて報告してください：

1. 実行したSQL文
2. エラーメッセージの全文
3. 実行環境（開発/本番）
4. 実行時刻

---

このマイグレーションにより、コミュニティ機能がより安定して動作し、適切な権限管理が行われるようになります。