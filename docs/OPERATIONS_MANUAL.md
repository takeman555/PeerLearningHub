# PeerLearningHub 運用マニュアル

## 概要

PeerLearningHub v1.0.0の日常運用手順、監視ダッシュボードの使用方法、定期チェック項目、監視項目とアラート対応手順を定義します。

## 目次

1. [日常運用手順](#日常運用手順)
2. [監視ダッシュボード使用方法](#監視ダッシュボード使用方法)
3. [定期チェック項目](#定期チェック項目)
4. [監視項目とアラート対応](#監視項目とアラート対応)
5. [定期メンテナンス](#定期メンテナンス)
6. [緊急時対応](#緊急時対応)

## 日常運用手順

### 1. 朝の運用開始チェック（毎日 9:00）

#### システム状態確認
```bash
# 1. アプリケーション状態確認
npm run health:check

# 2. データベース接続確認
node scripts/testSupabaseConnection.js

# 3. 外部システム連携確認
node scripts/testExternalLinkIntegration.js

# 4. 監視システム状態確認
node scripts/validatePerformanceMonitoring.js
```

#### 監視ダッシュボード確認
1. **パフォーマンス監視ダッシュボード**にアクセス
2. **エラー監視ダッシュボード**で夜間のエラー状況を確認
3. **ユーザー分析ダッシュボード**で利用状況を確認
4. **構造化ログダッシュボード**で異常ログを確認

#### 確認項目チェックリスト
- [ ] アプリケーションが正常に動作している
- [ ] データベース接続が正常
- [ ] 外部システム連携が正常
- [ ] 監視システムが正常に動作している
- [ ] 夜間にクリティカルなエラーが発生していない
- [ ] パフォーマンス指標が正常範囲内
- [ ] ユーザー数・利用状況が正常

### 2. 日中の定期チェック（毎時）

#### 自動監視項目
- アプリケーションエラー率
- レスポンス時間
- データベースパフォーマンス
- メモリ・CPU使用率
- ネットワーク通信状況

#### 手動確認項目
```bash
# システムメトリクス確認
node scripts/validateProductionEnvironment.js

# ユーザー分析データ確認
node scripts/validateUserAnalytics.js
```

### 3. 夕方の運用終了チェック（毎日 18:00）

#### 日次レポート生成
```bash
# 1. パフォーマンスレポート生成
node scripts/generatePerformanceReport.js

# 2. エラーレポート生成
node scripts/generateErrorReport.js

# 3. ユーザー分析レポート生成
node scripts/generateUserAnalyticsReport.js

# 4. 日次バックアップ確認
node scripts/verifyDailyBackup.js
```

#### 翌日準備
- [ ] 日次レポートの確認と保存
- [ ] 翌日のメンテナンス予定確認
- [ ] アラート設定の確認
- [ ] バックアップ状況の確認

## 監視ダッシュボード使用方法

### 1. パフォーマンス監視ダッシュボード

#### アクセス方法
- アプリ内: 管理者メニュー → パフォーマンス監視
- URL: `/admin/performance-monitoring`

#### 主要メトリクス
1. **レスポンス時間**
   - 画面遷移時間（目標: 1秒以内）
   - API呼び出し時間（目標: 3秒以内）
   - データベースクエリ時間（目標: 2秒以内）
   - レンダリング時間（目標: 0.5秒以内）

2. **システムメトリクス**
   - メモリ使用量（警告: 150MB以上）
   - CPU使用率（警告: 80%以上）
   - バッテリー消費率
   - ネットワークタイプ

3. **ネットワーク統計**
   - リクエスト数
   - 平均レイテンシ（警告: 1秒以上）
   - エラー率（警告: 5%以上）
   - データ転送量

4. **ユーザー体験指標**
   - アプリ起動時間（目標: 3秒以内）
   - インタラクティブ時間（目標: 5秒以内）
   - フレームドロップ数（警告: 10回以上）

#### 使用方法
1. ダッシュボードにアクセス
2. 時間範囲を選択（1時間、6時間、24時間、7日間）
3. 各メトリクスの値を確認
4. 異常値がある場合は詳細を調査
5. 必要に応じてアラートルールを調整

### 2. エラー監視ダッシュボード

#### 主要機能
1. **リアルタイムエラー監視**
   - エラー発生率
   - エラーの種類別分類
   - 重要度別アラート

2. **クラッシュレポート**
   - アプリクラッシュの詳細情報
   - ユーザーアクション履歴
   - デバイス情報

3. **アラート管理**
   - アラートルールの設定
   - 通知チャネルの管理
   - エスカレーション設定

#### 使用方法
```bash
# エラー監視ダッシュボードの起動
node scripts/setupErrorMonitoring.js

# エラーレポートの確認
node scripts/generateErrorReport.js
```

### 3. ユーザー分析ダッシュボード

#### 主要メトリクス
1. **ユーザー行動分析**
   - 画面遷移パターン
   - 機能利用状況
   - セッション時間

2. **コンバージョン分析**
   - 登録率
   - メンバーシップ購入率
   - 機能利用率

3. **リテンション分析**
   - 日次アクティブユーザー
   - 週次アクティブユーザー
   - 月次アクティブユーザー

#### 使用方法
```bash
# ユーザー分析レポート生成
node scripts/validateUserAnalytics.js

# 分析データの確認
node scripts/generateUserAnalyticsReport.js
```

### 4. 構造化ログダッシュボード

#### ログレベル
- **ERROR**: 即座対応が必要なエラー
- **WARN**: 注意が必要な警告
- **INFO**: 一般的な情報ログ
- **DEBUG**: デバッグ用詳細ログ

#### 検索・フィルタリング
1. **時間範囲指定**
2. **ログレベル指定**
3. **カテゴリ指定**（auth, community, external_systems等）
4. **キーワード検索**
5. **ユーザーID指定**

#### 使用方法
```bash
# 構造化ログの確認
node scripts/validateStructuredLogging.js

# ログ検索とエクスポート
node scripts/exportStructuredLogs.js
```

## 定期チェック項目

### 毎日のチェック項目

#### 朝（9:00）
- [ ] システム全体の稼働状況確認
- [ ] 夜間発生エラーの確認と対応
- [ ] データベースバックアップ状況確認
- [ ] 外部システム連携状況確認
- [ ] パフォーマンス指標の確認

#### 昼（12:00）
- [ ] ユーザー利用状況の確認
- [ ] リアルタイムエラー監視
- [ ] システムリソース使用状況確認

#### 夕方（18:00）
- [ ] 日次レポートの生成と確認
- [ ] 翌日のメンテナンス計画確認
- [ ] アラート設定の見直し

### 週次のチェック項目（毎週月曜日）

#### システム健全性チェック
```bash
# 週次システムチェック
npm run test:weekly-health-check

# パフォーマンス分析
node scripts/generateWeeklyPerformanceReport.js

# セキュリティスキャン
npm run security:scan
```

#### チェック項目
- [ ] 週間パフォーマンストレンド分析
- [ ] エラー発生パターン分析
- [ ] ユーザー行動分析レポート確認
- [ ] データベース最適化の実行
- [ ] セキュリティスキャン結果確認
- [ ] 依存関係の脆弱性チェック
- [ ] バックアップデータの整合性確認

### 月次のチェック項目（毎月1日）

#### 包括的システム評価
```bash
# 月次包括チェック
npm run test:monthly-comprehensive

# 月次レポート生成
node scripts/generateMonthlyReport.js
```

#### チェック項目
- [ ] 月間パフォーマンス総合評価
- [ ] ユーザー満足度分析
- [ ] システム容量計画の見直し
- [ ] セキュリティポリシーの見直し
- [ ] 災害復旧計画のテスト
- [ ] 運用手順書の更新
- [ ] 監視アラート閾値の調整

## 監視項目とアラート対応

### 1. クリティカルアラート（即座対応）

#### アプリケーションダウン
**症状**: アプリケーションが応答しない
**対応手順**:
1. システム状態確認
   ```bash
   node scripts/validateProductionEnvironment.js
   ```
2. データベース接続確認
   ```bash
   node scripts/testSupabaseConnection.js
   ```
3. 緊急ロールバック実行
   ```bash
   npm run rollback:emergency production
   ```
4. インシデント報告書作成

#### データベース接続エラー
**症状**: データベースへの接続が失敗
**対応手順**:
1. Supabase管理画面で状況確認
2. 接続設定の確認
3. 必要に応じてフェイルオーバー実行
4. 復旧後の整合性チェック

#### セキュリティインシデント
**症状**: 不正アクセスや異常なアクセスパターン
**対応手順**:
1. 該当アカウントの一時停止
2. アクセスログの詳細分析
3. セキュリティチームへのエスカレーション
4. 必要に応じてシステム一時停止

### 2. 高優先度アラート（1時間以内対応）

#### パフォーマンス劣化
**症状**: レスポンス時間が閾値を超過
**対応手順**:
1. パフォーマンス監視ダッシュボードで詳細確認
2. システムリソース使用状況確認
3. データベースクエリ最適化
4. 必要に応じてスケールアップ

#### エラー率上昇
**症状**: エラー発生率が5%を超過
**対応手順**:
1. エラーログの詳細分析
2. 影響範囲の特定
3. 根本原因の調査と修正
4. 修正版のデプロイ

#### 外部システム連携エラー
**症状**: 外部API呼び出しが失敗
**対応手順**:
1. 外部システムの状況確認
2. 接続設定の確認
3. フォールバック機能の有効化
4. 外部システム提供者への連絡

### 3. 中優先度アラート（4時間以内対応）

#### メモリ使用量上昇
**症状**: メモリ使用量が150MBを超過
**対応手順**:
1. メモリリークの調査
2. 不要なプロセスの特定と停止
3. アプリケーションの最適化
4. 監視閾値の見直し

#### ディスク容量不足
**症状**: ディスク使用量が80%を超過
**対応手順**:
1. 不要ファイルの削除
2. ログローテーションの実行
3. 古いバックアップの削除
4. 容量拡張の検討

### 4. 低優先度アラート（24時間以内対応）

#### ユーザー行動異常
**症状**: 通常と異なるユーザー行動パターン
**対応手順**:
1. ユーザー分析データの詳細確認
2. UI/UXの問題調査
3. 必要に応じて改善施策の検討

## 定期メンテナンス

### 日次メンテナンス（毎日 2:00-3:00）

#### 自動実行項目
```bash
# データベース最適化
node scripts/optimizeDatabase.js

# ログローテーション
node scripts/rotateApplicationLogs.js

# 一時ファイル削除
node scripts/cleanupTempFiles.js

# バックアップ実行
node scripts/executeDataCleanup.js
```

### 週次メンテナンス（毎週日曜日 1:00-4:00）

#### 実行項目
```bash
# 包括的データベースメンテナンス
node scripts/weeklyDatabaseMaintenance.js

# セキュリティスキャン
npm run security:comprehensive-scan

# パフォーマンステスト
npm run test:performance

# 依存関係更新チェック
npm audit
```

### 月次メンテナンス（毎月第1日曜日 0:00-6:00）

#### 実行項目
```bash
# システム全体の健全性チェック
npm run test:comprehensive-health

# データベース統計更新
node scripts/updateDatabaseStatistics.js

# 古いデータのアーカイブ
node scripts/archiveOldData.js

# 災害復旧テスト
node scripts/testDisasterRecovery.js
```

## 緊急時対応

### インシデント対応フロー

#### レベル1: 軽微な問題
- **対応時間**: 24時間以内
- **対応者**: 運用担当者
- **エスカレーション**: なし

#### レベル2: 中程度の問題
- **対応時間**: 4時間以内
- **対応者**: 運用担当者 + 開発者
- **エスカレーション**: 開発チームリーダー

#### レベル3: 重大な問題
- **対応時間**: 1時間以内
- **対応者**: 全開発チーム
- **エスカレーション**: プロジェクトマネージャー

#### レベル4: クリティカルな問題
- **対応時間**: 即座
- **対応者**: 全チーム + 外部サポート
- **エスカレーション**: 経営陣

### 緊急連絡先

#### 内部連絡先
- **運用チーム**: operations@peerlearninghub.com
- **開発チーム**: dev-team@peerlearninghub.com
- **セキュリティチーム**: security@peerlearninghub.com
- **緊急時**: emergency@peerlearninghub.com

#### 外部連絡先
- **Supabase サポート**: support@supabase.com
- **RevenueCat サポート**: support@revenuecat.com
- **Expo サポート**: Discord コミュニティ

### 緊急時コマンド

#### システム停止
```bash
# アプリケーション緊急停止
npm run emergency:stop

# メンテナンスモード有効化
npm run maintenance:enable
```

#### 緊急ロールバック
```bash
# 最新の安定版にロールバック
npm run rollback:emergency production

# 特定バージョンにロールバック
npm run rollback:to-version production v1.0.0
```

#### データ復旧
```bash
# 最新バックアップから復旧
node scripts/restoreFromBackup.js latest

# 特定時点から復旧
node scripts/restoreFromBackup.js "2024-01-01T00:00:00Z"
```

## 運用ログ

### 日次運用ログテンプレート

```
日付: YYYY-MM-DD
運用担当者: [名前]

【朝のチェック結果】
- システム状態: [正常/異常]
- エラー発生: [なし/あり - 詳細]
- パフォーマンス: [正常/要注意]
- 外部システム: [正常/異常]

【日中の対応事項】
- インシデント: [なし/あり - 詳細]
- メンテナンス: [なし/あり - 詳細]
- ユーザー問い合わせ: [件数と概要]

【夕方のチェック結果】
- 日次レポート: [正常/異常]
- バックアップ: [成功/失敗]
- 翌日準備: [完了/未完了]

【特記事項】
[その他の重要な事項]
```

## 改善提案

### 運用効率化
- 監視アラートの自動化拡張
- レポート生成の自動化
- 定期メンテナンスの自動化

### 監視強化
- ユーザー体験指標の追加
- ビジネスメトリクスの監視
- 予測的アラートの導入

### 文書化改善
- 手順書の動画化
- トラブルシューティングガイドの充実
- ナレッジベースの構築